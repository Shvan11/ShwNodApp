# Caddyfile: C:\Caddy\Caddyfile

{
    # FORCES Caddy to store ALL data (certs, logs) in this explicit location
    storage file_system {
        root C:\Caddy\data
    }

    # Email for Let's Encrypt notifications (cert expiration warnings)
    email Schwan.ortho@gmail.com
}

# LOCAL HTTPS Configuration - PRODUCTION (Clinic LAN)
local.shwan-orthodontics.com {
    # Use Cloudflare DNS-01 challenge for Let's Encrypt
    tls {
        dns cloudflare {env.CLOUDFLARE_API_TOKEN}
    }

    # Reverse proxy to Node.js
    reverse_proxy localhost:3000

    # Enable compression
    encode gzip

    # Security headers
    header {
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }

    # WebSocket support for real-time messaging
    @websocket {
        header Connection *Upgrade*
        header Upgrade websocket
    }
    reverse_proxy @websocket localhost:3000

    # Logging for debugging
    log {
        output file C:\Caddy\logs\local-clinic.log
        level INFO
    }
}
