<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shwan Orthodontics - Practice Management</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Application CSS -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components/universal-header.css">

    <!-- Page-specific CSS (loaded globally for SPA) -->
    <link rel="stylesheet" href="/css/pages/dashboard.css">
    <link rel="stylesheet" href="/css/pages/patient-shell.css">
    <link rel="stylesheet" href="/css/pages/grid.css">
    <link rel="stylesheet" href="/css/pages/add-patient.css">
    <link rel="stylesheet" href="/css/pages/appointments.css">
    <link rel="stylesheet" href="/css/pages/send.css">
    <link rel="stylesheet" href="/css/pages/aligner.css">
    <link rel="stylesheet" href="/css/pages/expenses.css">
    <link rel="stylesheet" href="/css/pages/settings.css">
    <link rel="stylesheet" href="/css/pages/template-management.css">
    <link rel="stylesheet" href="/css/pages/template-designer.css">
    <link rel="stylesheet" href="/css/pages/statistics.css">
    <link rel="stylesheet" href="/css/pages/work-management.css">
    <link rel="stylesheet" href="/css/pages/visits-summary.css">
    <link rel="stylesheet" href="/css/pages/visits-spacing.css">
    <link rel="stylesheet" href="/css/pages/xrays.css">
    <link rel="stylesheet" href="/css/pages/work-payments.css">

    <!-- Component CSS -->
    <link rel="stylesheet" href="/css/components/buttons.css">
    <link rel="stylesheet" href="/css/components/sidebar-navigation.css">
    <link rel="stylesheet" href="/css/components/dental-chart.css">
    <link rel="stylesheet" href="/css/components/appointment-calendar.css">
    <link rel="stylesheet" href="/css/components/appointment-form.css">
    <link rel="stylesheet" href="/css/components/calendar-picker-modal.css">
    <link rel="stylesheet" href="/css/components/simplified-calendar-picker.css">
    <link rel="stylesheet" href="/css/components/monthly-calendar-view.css">
    <link rel="stylesheet" href="/css/components/timepoints-selector.css">
    <link rel="stylesheet" href="/css/components/visits-component.css">
    <link rel="stylesheet" href="/css/components/new-visit-component.css">
    <link rel="stylesheet" href="/css/components/work-card.css">
    <link rel="stylesheet" href="/css/components/new-work-component.css">
    <link rel="stylesheet" href="/css/components/invoice-form.css">
    <link rel="stylesheet" href="/css/components/aligner-set-card.css">
    <link rel="stylesheet" href="/css/components/aligner-drawer-form.css">
    <link rel="stylesheet" href="/css/components/whatsapp-auth.css">

    <!-- PhotoSwipe CSS for image lightbox -->
    <link rel="stylesheet" href="/photoswipe/dist/photoswipe.css">

    <!-- Loading spinner animation for React.lazy() -->
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <!-- React and dependencies are bundled by Vite for optimal performance -->
    <!-- Using latest stable React 19.1.0 with full bundling (best practice 2025) -->
    <!-- No CDN imports - everything is optimized and tree-shaken in the build -->

    <!-- Global Styles -->
    <style>
        /* Note: Basic resets are handled by /css/base/reset.css */

        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f8f9fa;
        }

        code {
            font-family: source-code-pro, Menlo, Monaco, Consolas, 'Courier New', monospace;
        }

        /* Loading spinner */
        .spa-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f8f9fa;
        }

        .spa-loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Application container */
        #single-spa-application {
            min-height: 100vh;
        }

        /* Universal header container */
        #universal-header-root {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            min-height: 50px;
        }

        /* App container - offset for fixed header */
        #app-container {
            padding: 0;
            margin: 0;
            padding-top: 50px;
        }

        /* Mobile responsive padding to prevent header overlap */
        @media (max-width: 1024px) {
            #app-container {
                padding-top: 80px;
            }
        }

        @media (max-width: 768px) {
            #app-container {
                padding-top: 110px;
            }
        }

        @media (max-width: 640px) {
            #app-container {
                padding-top: 100px;
            }
        }

        @media (max-width: 480px) {
            #app-container {
                padding-top: 95px;
            }
        }

        @media (max-width: 375px) {
            #app-container {
                padding-top: 90px;
            }
        }

        /* Smooth transitions between routes */
        .app-transition {
            animation: fadeIn 0.2s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Error boundary styles */
        .error-boundary {
            padding: 40px;
            text-align: center;
            background-color: #fee;
            border: 2px solid #fcc;
            border-radius: 8px;
            margin: 20px;
        }

        .error-boundary h2 {
            color: #c33;
            margin-bottom: 10px;
        }

        .error-boundary p {
            color: #666;
        }
    </style>
</head>
<body>
    <!-- React Application Container -->
    <!-- Unified React app with BrowserRouter will be mounted here -->
    <div id="single-spa-application">
        <!-- Initial loading state (removed after React mounts) -->
        <div class="spa-loading">
            <div class="spa-loading-spinner"></div>
        </div>
    </div>

    <!-- Global Fetch Interceptor for Authentication -->
    <script>
        // Intercept all fetch requests to handle 401 authentication errors globally
        // This ensures consistent redirect behavior across all components
        (function() {
            const originalFetch = window.fetch;

            window.fetch = function(...args) {
                return originalFetch.apply(this, args)
                    .then(response => {
                        // Check for 401 Unauthorized
                        if (response.status === 401) {
                            console.warn('[Auth] 401 Unauthorized detected - redirecting to login');
                            // Redirect to login page
                            window.location.href = '/login.html';
                            // Return a rejected promise to prevent further processing
                            return Promise.reject(new Error('Authentication required'));
                        }
                        return response;
                    });
            };

            console.log('[Auth] Global fetch interceptor installed');
        })();
    </script>

    <!-- Unified React Application Bootstrap -->
    <script type="module">
        import React from 'react';
        import ReactDOM from 'react-dom/client';
        import { BrowserRouter } from 'react-router-dom';

        console.log('[App] Initializing unified React application');

        // Import main App component
        import App from '/js/App.jsx';

        // Wait for ALL resources (including CSS) to load
        window.addEventListener('load', async () => {
            console.log('[App] All resources loaded - mounting application');

            // Clear loading spinner and prepare root element
            const appContainer = document.getElementById('single-spa-application');
            appContainer.innerHTML = '<div id="app-root"></div>';

            // Mount the unified React application
            // ONE BrowserRouter, ONE React tree, ALL routes in App.jsx
            const root = ReactDOM.createRoot(document.getElementById('app-root'));

            try {
                root.render(
                    React.createElement(React.StrictMode, null,
                        React.createElement(BrowserRouter, null,
                            React.createElement(App)
                        )
                    )
                );

                console.log('[App] Application mounted successfully');
            } catch (error) {
                console.error('[App] Failed to mount application:', error);

                // Show error to user
                appContainer.innerHTML = `
                    <div class="error-boundary">
                        <h2>Application Failed to Start</h2>
                        <p>Unable to initialize the application. Please refresh the page.</p>
                        <p style="color: #999; font-size: 12px; margin-top: 10px;">
                            Error: ${error.message}
                        </p>
                    </div>
                `;
            }
        });

        // Global error handler
        window.addEventListener('error', (event) => {
            console.error('[App] Global error:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('[App] Unhandled promise rejection:', event.reason);
        });

        // Performance monitoring
        window.addEventListener('load', () => {
            if (window.performance) {
                const perfData = window.performance.timing;
                const pageLoadTime = perfData.loadEventEnd - perfData.navigationStart;
                console.log(`[App] Page load time: ${pageLoadTime}ms`);
            }
        });
    </script>

    <!-- Service Worker Registration (Future Enhancement) -->
    <!--
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => console.log('[SW] Service Worker registered'))
                    .catch(err => console.error('[SW] Service Worker registration failed:', err));
            });
        }
    </script>
    -->
</body>
</html>
