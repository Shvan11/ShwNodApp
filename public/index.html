<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shwan Orthodontics - Practice Management</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- TomSelect for patient search -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.css">

    <!-- Application CSS -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components/universal-header.css">

    <!-- Page-specific CSS (loaded globally for SPA) -->
    <link rel="stylesheet" href="/css/pages/dashboard.css">
    <link rel="stylesheet" href="/css/pages/expenses.css">
    <link rel="stylesheet" href="/css/pages/appointments.css">
    <link rel="stylesheet" href="/css/pages/grid.css">
    <link rel="stylesheet" href="/css/pages/work-management.css">

    <!-- Import Map for ESM Dependencies -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom": "https://esm.sh/react-dom@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "react-router-dom": "https://esm.sh/react-router-dom@7.9.0",
            "date-fns": "https://esm.sh/date-fns@2.30.0",
            "axios": "https://esm.sh/axios@1.6.0"
        }
    }
    </script>

    <!-- Global Styles -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f8f9fa;
        }

        code {
            font-family: source-code-pro, Menlo, Monaco, Consolas, 'Courier New', monospace;
        }

        /* Loading spinner */
        .spa-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f8f9fa;
        }

        .spa-loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Single-SPA container */
        #single-spa-application {
            min-height: 100vh;
        }

        /* Prevent layout shift during app loading */
        #universal-header-root {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #app-container {
            padding-top: 0;
        }

        /* Smooth transitions between apps */
        .app-transition {
            animation: fadeIn 0.2s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Error boundary styles */
        .error-boundary {
            padding: 40px;
            text-align: center;
            background-color: #fee;
            border: 2px solid #fcc;
            border-radius: 8px;
            margin: 20px;
        }

        .error-boundary h2 {
            color: #c33;
            margin-bottom: 10px;
        }

        .error-boundary p {
            color: #666;
        }
    </style>
</head>
<body>
    <!-- Single-SPA Application Container -->
    <!-- BrowserRouter and all content will be mounted here by React -->
    <div id="single-spa-application">
        <!-- Initial loading state (removed after React mounts) -->
        <div class="spa-loading">
            <div class="spa-loading-spinner"></div>
        </div>
    </div>

    <!-- Single-SPA Bootstrap Script -->
    <script type="module">
        import React from 'react';
        import ReactDOM from 'react-dom/client';
        import { BrowserRouter } from 'react-router-dom';

        console.log('[SPA] Initializing single-page application');

        // Import global state provider
        import { GlobalStateProvider } from '/single-spa/contexts/GlobalStateContext.jsx';

        // Import UniversalHeader (mounted once)
        import UniversalHeader from '/js/components/react/UniversalHeader.jsx';

        // Wait for ALL resources (including CSS) to load
        window.addEventListener('load', async () => {
            console.log('[SPA] All resources loaded - mounting application');

            // Clear loading spinner
            const appContainer = document.getElementById('single-spa-application');
            const existingContainer = document.getElementById('app-container');
            if (!existingContainer) {
                // Create structure for header and apps
                appContainer.innerHTML = `
                    <div id="universal-header-root"></div>
                    <div id="app-container"></div>
                `;
            }

            // Mount UniversalHeader with its own BrowserRouter
            const headerRoot = ReactDOM.createRoot(
                document.getElementById('universal-header-root')
            );

            headerRoot.render(
                React.createElement(BrowserRouter, null,
                    React.createElement(GlobalStateProvider, null,
                        React.createElement(UniversalHeader)
                    )
                )
            );

            console.log('[SPA] UniversalHeader mounted');

            // Import and start single-spa root config
            // This will register all apps and start the routing system
            try {
                await import('/single-spa/root-config.js');
                console.log('[SPA] Single-SPA started successfully');
            } catch (error) {
                console.error('[SPA] Failed to start single-spa:', error);

                // Show error to user
                appContainer.innerHTML = `
                    <div class="error-boundary">
                        <h2>Application Failed to Start</h2>
                        <p>Unable to initialize the application. Please refresh the page.</p>
                        <p style="color: #999; font-size: 12px; margin-top: 10px;">
                            Error: ${error.message}
                        </p>
                    </div>
                `;
            }
        });

        // Global error handler
        window.addEventListener('error', (event) => {
            console.error('[SPA] Global error:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('[SPA] Unhandled promise rejection:', event.reason);
        });

        // Performance monitoring
        window.addEventListener('load', () => {
            if (window.performance) {
                const perfData = window.performance.timing;
                const pageLoadTime = perfData.loadEventEnd - perfData.navigationStart;
                console.log(`[SPA] Page load time: ${pageLoadTime}ms`);
            }
        });
    </script>

    <!-- Service Worker Registration (Future Enhancement) -->
    <!--
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => console.log('[SW] Service Worker registered'))
                    .catch(err => console.error('[SW] Service Worker registration failed:', err));
            });
        }
    </script>
    -->
</body>
</html>
