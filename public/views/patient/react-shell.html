<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Portal</title>

    <link rel="stylesheet" href="../../css/main.css">
    <link rel="stylesheet" href="../../css/pages/grid.css">
    <link rel="stylesheet" href="../../css/pages/payments.css">
    <link rel="stylesheet" href="../../css/pages/xrays.css">
    <link rel="stylesheet" href="../../css/pages/visits-summary.css">
    <link rel="stylesheet" href="../../css/pages/canvas.css">
    <link rel="stylesheet" href="../../photoswipe/dist/photoswipe.css">
    <link rel="stylesheet" href="../../css/components/universal-header.css">
    <link rel="stylesheet" href="../../css/components/sidebar-navigation.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- React Local Files -->
    <script crossorigin src="../../js/vendor/react.production.min.js"></script>
    <script crossorigin src="../../js/vendor/react-dom.production.min.js"></script>

    <style>
        /* React shell specific styles for sidebar layout */
        html, body {
            margin: 0 !important;
            padding: 0 !important;
            overflow: hidden; /* Prevent body scroll */
        }
        
        #universal-header-root {
            margin: 0 !important;
            padding: 0 !important;
            line-height: 0; /* Remove any line-height spacing */
        }
        
        #react-root {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden; /* Prevent root scroll */
        }

        .patient-shell-container {
            height: 100%;
            display: flex;
            position: relative;
        }

        .main-content-area {
            flex: 1;
            margin-left: 64px; /* Start with collapsed sidebar width */
            overflow: hidden; /* Prevent main scroll, let content handle its own */
            position: relative;
            min-height: 0;
            background: #ffffff;
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            height: calc(100vh - 50px); /* Account for reduced universal header */
        }

        /* Adjust content area when sidebar is expanded */
        .patient-sidebar:not(.collapsed) ~ .main-content-area {
            margin-left: 280px;
        }

        /* Mobile adjustments */
        @media (max-width: 768px) {
            .main-content-area {
                margin-left: 0;
            }
            
            .patient-sidebar.mobile:not(.collapsed) ~ .main-content-area {
                filter: blur(2px);
                pointer-events: none;
            }
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 18px;
            color: var(--text-color);
        }

        .loading-spinner::after {
            content: "";
            width: 20px;
            height: 20px;
            margin-left: 10px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .error-message {
            padding: 20px;
            text-align: center;
            color: #e74c3c;
            font-size: 16px;
        }

        /* Mobile overlay for sidebar */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1050;
            backdrop-filter: blur(2px);
        }

        @media (max-width: 768px) {
            .patient-sidebar.mobile:not(.collapsed) + .sidebar-overlay {
                display: block;
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

    </style>
</head>

<body>
    <!-- Universal header mount point -->
    <div id="universal-header-root"></div>
    <!-- React will mount here -->
    <div id="react-root"></div>

    <!-- Navigation Context -->
    <script src="../../js/services/navigationContext.js"></script>
    <script src="../../js/components/shared/UniversalHeader.js"></script>
    
    <!-- React Components - Imported in correct order -->
    <script src="../../js/components/react/Navigation.js"></script>
    <script src="../../js/components/react/GridComponent.js"></script>
    <script src="../../js/components/react/InvoiceComponent.js"></script>
    <script src="../../js/components/react/PaymentsComponent.js"></script>
    <script src="../../js/components/react/XraysComponent.js"></script>
    <script src="../../js/components/react/VisitsComponent.js"></script>
    <script src="../../js/components/react/CompareComponent.js"></script>
    <script src="../../js/components/react/ContentRenderer.js"></script>
    <script src="../../js/components/react/PatientShell.js"></script>
    <script src="../../js/components/react/App.js"></script>

    <!-- Initialize React App -->
    <script>
        console.log('üöÄ Initializing React Patient Portal...');

        // Verify all components are loaded
        const requiredComponents = [
            'Navigation', 'GridComponent', 'InvoiceComponent', 'PaymentsComponent',
            'XraysComponent', 'VisitsComponent', 'CompareComponent',
            'ContentRenderer', 'PatientShell', 'App'
        ];

        const missingComponents = requiredComponents.filter(name => !window[name]);

        if (missingComponents.length > 0) {
            console.error('‚ùå Missing components:', missingComponents);
            document.getElementById('react-root').innerHTML = `
                <div style="padding: 20px; text-align: center; color: red;">
                    <h2>Error: Missing Components</h2>
                    <p>The following components failed to load: ${missingComponents.join(', ')}</p>
                    <p>Please check the console for more details.</p>
                </div>
            `;
        } else {
            console.log('‚úÖ All components loaded successfully');

            // Mount Universal Header
            const headerRoot = document.getElementById('universal-header-root');
            if (headerRoot && window.UniversalHeader) {
                const headerReactRoot = ReactDOM.createRoot(headerRoot);
                headerReactRoot.render(React.createElement(window.UniversalHeader));
                console.log('‚úÖ Universal Header initialized');
            }

            // Mount React App
            const root = ReactDOM.createRoot(document.getElementById('react-root'));
            root.render(React.createElement(window.App));

            // Add mobile sidebar overlay handling
            const addMobileOverlay = () => {
                let overlay = document.querySelector('.sidebar-overlay');
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.className = 'sidebar-overlay';
                    overlay.addEventListener('click', () => {
                        // Trigger sidebar collapse on overlay click
                        const sidebar = document.querySelector('.patient-sidebar');
                        if (sidebar && sidebar.classList.contains('mobile')) {
                            const toggleBtn = sidebar.querySelector('.sidebar-toggle');
                            if (toggleBtn) toggleBtn.click();
                        }
                    });
                    document.body.appendChild(overlay);
                }
            };

            // Add observer to handle content area margin adjustments
            const setupContentAreaObserver = () => {
                const adjustContentMargin = () => {
                    const sidebar = document.querySelector('.patient-sidebar');
                    const contentArea = document.querySelector('.main-content-area');
                    
                    if (sidebar && contentArea) {
                        const isMobile = window.innerWidth <= 768;
                        const isCollapsed = sidebar.classList.contains('collapsed');
                        
                        if (isMobile) {
                            contentArea.style.marginLeft = '0';
                        } else {
                            contentArea.style.marginLeft = isCollapsed ? '64px' : '280px';
                        }
                    }
                };

                // Watch for changes in sidebar classes
                const observer = new MutationObserver(adjustContentMargin);
                const sidebar = document.querySelector('.patient-sidebar');
                
                if (sidebar) {
                    observer.observe(sidebar, { 
                        attributes: true, 
                        attributeFilter: ['class'] 
                    });
                }

                // Initial adjustment and window resize handling
                adjustContentMargin();
                window.addEventListener('resize', adjustContentMargin);
            };

            // Setup content area observer after a delay
            setTimeout(setupContentAreaObserver, 200);

            // Add overlay after a short delay to ensure DOM is ready
            setTimeout(addMobileOverlay, 100);

            console.log('‚úÖ React Patient Portal initialized successfully');
        }
    </script>
</body>

</html>